var modules = {};
! function(a) {
    a(document).ready(function() {
        function o(a) {
            return void 0 !== window.ontouchstart && u[a] && (a = u[a]), a
        }

        function e(a) {
            return a.originalEvent.changedTouches ? {
                pageX: a.originalEvent.changedTouches[0].pageX,
                pageY: a.originalEvent.changedTouches[0].pageY
            } : {
                pageX: a.pageX,
                pageY: a.pageY
            }
        }

        function n() {
            l.$canvas.drawRect({
                fillStyle: "#fff",
                x: 0,
                y: 0,
                width: l.canvasW,
                height: l.canvasH,
                fromCenter: !1
            })
        }

        function s(a) {
            l.$canvas.clearCanvas(), l.$canvas.drawImage({
                source: a,
                x: 0,
                y: 0,
                width: l.canvasW,
                height: l.canvasH,
                fromCenter: !1
            })
        }

        function t() {
            d.stroke.width(l.stroke), d.stroke.height(l.stroke), d.stroke.css({
                marginLeft: (d.box.width() - d.stroke.width()) / 2,
                marginTop: (d.box.height() - d.stroke.height()) / 2
            }), !1 === l.start ? (d.stroke.css({
                backgroundColor: l.color
            }), l.start += 1) : !0 === l.start && d.stroke.stop().animate({
                backgroundColor: l.color
            }, i), l.start = !0
        }

        modules.color = function c(color) {
        	l.color = "#"+color, t()
        }

        function r(a) {
            var o = d.slider.width();
            d.slider.children("#filler").width(o * (a / 100))
        }
        var i, l = {
                $canvas: a("#canvas"),
                color: "000000",
                press: !1,
                last: new Image,
                hist: [],
                undoHist: [],
                clicks: 0,
                start: !1
            },
            d = {
                stroke: a("#stroke"),
                strokeContainer: a("#stroke-container"),
                box: a("#box"),
                tools: a("#tools"),
                clear: a("#clear"),
                slider: a("#slider"),
                colors: a("#colors"),
                brush: a("#brush"),
                path: a("#path"),
                rect: a("#rect"),
                ellipse: a("#ellipse"),
                undo: a("#undo"),
                redo: a("#redo"),
                save: a("#save")
            },
            u = {
                mousedown: "touchstart",
                mouseup: "touchend",
                mousemove: "touchmove"
            };
        l.getTouchEventName = o, l.getPageCoords = e, l.clearCanvas = n;
        var h = {
                red: {
                    dark: "#a11",
                    medium: "#c33",
                    light: "#e55"
                },
                green: {
                    dark: "#4b1",
                    medium: "#6d2",
                    light: "#8f4"
                },
                blue: {
                    dark: "#14b",
                    medium: "#36d",
                    light: "#58f"
                },
                orange: {
                    dark: "#d51",
                    medium: "#f73",
                    light: "#f95"
                },
                yellow: {
                    dark: "#ed2",
                    medium: "#fe3",
                    light: "#ff5"
                },
                purple: {
                    dark: "#75d",
                    medium: "#96f",
                    light: "#b8f"
                },
                black: {
                    dark: "#000",
                    medium: "#999",
                    light: "#fff"
                }
            },
            g = ["red", "green", "blue", "orange", "yellow", "purple", "brown", "white", "black"],
            v = ["light", "medium", "dark"];
        d.tools.on("click", ".tool", function() {
                d.tools.find(".chosen").removeClass("chosen"), a(this).addClass("chosen")
            }), d.clear.on("click", function() {
                l.$canvas.trigger("mouseup"), l.last.src = l.$canvas[0].toDataURL("image/png"), l.hist.push(l.last.src), n(), l.clicks = 0
            }), d.save.on("click", function() {
                var a = l.$canvas[0].toDataURL("image/png");
                l.$canvas.mouseup(), window.open(a)
            }), d.undo.on("click", function() {
                l.$canvas.mouseup(), l.hist.length > 0 && (l.clicks = 0, l.undoHist.push(l.$canvas[0].toDataURL("image/png")), s(l.hist.pop()))
            }), d.redo.on("click", function() {
                if (l.$canvas.mouseup(), l.undoHist.length > 0) {
                    l.clicks = 0;
                    var a = l.undoHist.pop();
                    l.hist.push(l.$canvas[0].toDataURL("image/png")), s(a)
                }
            }), d.brush.on("click", function() {
                l.$canvas.brushTool(l)
            }), d.path.on("click", function() {
                l.last.src = l.$canvas[0].toDataURL("image/png"), l.$canvas.pathTool(l)
            }), d.rect.on("click", function() {
                l.last.src = l.$canvas[0].toDataURL("image/png"), l.$canvas.rectTool(l)
            }), d.ellipse.on("click", function() {
                l.last.src = l.$canvas[0].toDataURL("image/png"), l.$canvas.ellipseTool(l)
            }), d.brush.click(),
            function() {
                var o, e;
                for (e = 0; e < v.length; e += 1)
                    for (o = 0; o < g.length; o += 1) ! function(o, e) {
                        h[o] && h[o][e] && a('<div class="color ' + o + " " + e + '" />').css({
                            backgroundColor: h[o][e]
                        }).appendTo("#colors")
                    }(g[o], v[e])
            }(), modules.color(l.color), d.slider.slider({
                min: 1,
                value: 50
            });
        var p = d.slider.slider("option", "value");
        r(p), l.stroke = Math.round(p / 2), t(), d.slider.bind("slide", function(a, o) {
                var e = o.value;
                l.stroke = Math.round(e / 2), t(), r(e)
            }),
            function() {
                var a = l.$canvas.getCanvasImage("image/png");
                l.canvasW = l.$canvas.attr("width"), l.canvasH = l.$canvas.attr("height"), l.$canvas.prop({
                    width: l.canvasW,
                    height: l.canvasH
                }), l.$canvas.detectPixelRatio(), a.length > 10 && l.$canvas.drawImage({
                    source: a,
                    x: 0,
                    y: 0,
                    width: l.canvasW,
                    height: l.canvasH,
                    fromCenter: !1
                })
            }(), n()
    })
}(jQuery);
